<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - UTCN AC Timetable</title>
    <link rel="stylesheet" href="/frontend/assets/index-DL3vvXPq.css">
    <style>
        /* Admin-specific overrides */
        .admin-header {
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .admin-header .back-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            transition: all 0.2s;
        }
        .admin-header .back-link:hover {
            background: rgba(255,255,255,0.1);
        }
        .admin-notice {
            background: #fff3cd;
            color: #856404;
            padding: 0.75rem 1rem;
            text-align: center;
            font-size: 0.9rem;
        }
        @keyframes pulse {
            0%, 100% { width: 30%; margin-left: 0; }
            50% { width: 50%; margin-left: 25%; }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>Admin Panel</h1>
        <a href="/" class="back-link">‚Üê Back to Schedule</a>
    </div>
    <div class="admin-notice">
        You are logged in as administrator. All changes will be saved immediately.
    </div>
    <div id="admin-root"></div>
    
    <script type="module">
        import React from 'https://esm.sh/react@18'
        import ReactDOM from 'https://esm.sh/react-dom@18/client'
        
        const COLORS = ['#003366', '#0066cc', '#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#20c997', '#e83e8c']

        function Admin() {
            const [calendars, setCalendars] = React.useState([])
            const [loading, setLoading] = React.useState(true)
            const [importing, setImporting] = React.useState(false)
            const [extractorRunning, setExtractorRunning] = React.useState(false)
            const [extractorProgress, setExtractorProgress] = React.useState(null)
            const [message, setMessage] = React.useState(null)
            const [newCalendar, setNewCalendar] = React.useState({ url: '', name: '', color: '#003366' })
            const [editingCalendar, setEditingCalendar] = React.useState(null)
            const [stats, setStats] = React.useState({ events_count: 0, last_import: null })
            const [importLog, setImportLog] = React.useState([])

            const fetchData = React.useCallback(async (showLoading = true) => {
                try {
                    if (showLoading) setLoading(true)
                    const res = await fetch('/admin/api/status')
                    if (res.ok) {
                        const data = await res.json()
                        setCalendars(data.calendars || [])
                        // manual events are intentionally excluded from this admin UI
                        setStats({ events_count: data.events_count || 0, last_import: data.last_import })
                        setExtractorRunning(data.extractor_running || false)
                        setExtractorProgress(data.extractor_progress || null)
                        
                        // Auto-add progress messages to log
                        if (data.extractor_progress && data.extractor_progress.message) {
                            setImportLog(prev => {
                                const lastMsg = prev.length > 0 ? prev[prev.length - 1].msg : ''
                                if (lastMsg !== data.extractor_progress.message) {
                                    return [...prev, { 
                                        time: new Date().toLocaleTimeString(), 
                                        msg: data.extractor_progress.message, 
                                        type: 'info' 
                                    }]
                                }
                                return prev
                            })
                        }
                    }
                } catch (e) {
                    console.error(e)
                } finally {
                    if (showLoading) setLoading(false)
                }
            }, [])

            // Initial load
            React.useEffect(() => { fetchData() }, [fetchData])
            
            // Poll every 2 seconds when extractor is running
            React.useEffect(() => {
                const interval = setInterval(() => {
                    fetchData(false)
                }, 2000)
                return () => clearInterval(interval)
            }, [fetchData])

            const showMessage = (text, type) => {
                setMessage({ text, type })
                setTimeout(() => setMessage(null), 4000)
            }

            const addCalendar = async (e) => {
                e.preventDefault()
                if (!newCalendar.url) return showMessage('URL is required', 'error')
                
                try {
                    setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Adding calendar...', type: 'info' }])
                    const form = new FormData()
                    form.append('calendar_url', newCalendar.url)
                    form.append('calendar_name', newCalendar.name)
                    form.append('calendar_color', newCalendar.color)
                    
                    const res = await fetch('/admin/set_calendar_url', { method: 'POST', body: form })
                    if (res.ok) {
                        setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Calendar added! Starting import...', type: 'success' }])
                        showMessage('Calendar added - importing events...', 'success')
                        setNewCalendar({ url: '', name: '', color: '#003366' })
                        fetchData(false)
                    }
                } catch (e) {
                    setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Error: ' + e.message, type: 'error' }])
                    showMessage('Error adding calendar', 'error')
                }
            }

            const importCalendar = async () => {
                setImporting(true)
                setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Starting import for all calendars...', type: 'info' }])
                try {
                    const res = await fetch('/admin/import_calendar', { method: 'POST' })
                    const data = await res.json()
                    setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: data.message || 'Import started', type: 'success' }])
                    showMessage(data.message || 'Import started', 'success')
                } catch (e) {
                    setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Import error: ' + e.message, type: 'error' }])
                    showMessage('Import error', 'error')
                } finally {
                    setImporting(false)
                }
            }

            const deleteCalendar = async (id) => {
                if (!confirm('Are you sure you want to delete this calendar?')) return
                try {
                    const form = new FormData()
                    form.append('id', id)
                    const res = await fetch('/admin/delete_calendar', { method: 'POST', body: form })
                    if (res.ok) {
                        showMessage('Calendar deleted', 'success')
                        fetchData()
                    }
                } catch (e) {
                    showMessage('Error deleting', 'error')
                }
            }

            // Manual event creation/deletion handlers removed from this admin UI

            const updateCalendar = async (e) => {
                e.preventDefault()
                if (!editingCalendar) return
                try {
                    const form = new FormData()
                    form.append('id', editingCalendar.id)
                    form.append('name', editingCalendar.name || '')
                    form.append('color', editingCalendar.color || '#003366')
                    form.append('enabled', editingCalendar.enabled ? '1' : '0')
                    const res = await fetch('/admin/update_calendar', { method: 'POST', body: form })
                    const data = await res.json()
                    if (data.success) {
                        showMessage('Calendar updated', 'success')
                        setEditingCalendar(null)
                        fetchData()
                    } else {
                        showMessage(data.message || 'Error updating', 'error')
                    }
                } catch (e) {
                    showMessage('Error updating calendar', 'error')
                }
            }

            if (loading) {
                return React.createElement('div', { className: 'admin-loading', style: { padding: '2rem', textAlign: 'center' } }, 
                    React.createElement('div', { className: 'spinner' }),
                    ' Loading...'
                )
            }

            return React.createElement('div', { className: 'admin-container', style: { padding: '2rem', maxWidth: '1200px', margin: '0 auto' } },
                // Message
                message && React.createElement('div', { 
                    className: `admin-message ${message.type}`,
                    style: { 
                        padding: '1rem', 
                        marginBottom: '1rem', 
                        borderRadius: '8px',
                        background: message.type === 'success' ? '#d4edda' : '#f8d7da',
                        color: message.type === 'success' ? '#155724' : '#721c24'
                    }
                }, message.text),

                // Stats
                React.createElement('div', { className: 'admin-stats', style: { 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                    gap: '1rem',
                    marginBottom: '2rem'
                }},
                    React.createElement('div', { style: { background: '#f8f9fa', padding: '1rem', borderRadius: '8px', textAlign: 'center' }},
                        React.createElement('div', { style: { fontSize: '2rem', fontWeight: 'bold', color: '#003366' }}, calendars.length),
                        React.createElement('div', { style: { color: '#666' }}, 'Calendars')
                    ),
                    React.createElement('div', { style: { background: '#f8f9fa', padding: '1rem', borderRadius: '8px', textAlign: 'center' }},
                        React.createElement('div', { style: { fontSize: '2rem', fontWeight: 'bold', color: '#003366' }}, stats.events_count),
                        React.createElement('div', { style: { color: '#666' }}, 'Events')
                    ),
                    React.createElement('div', { style: { background: '#f8f9fa', padding: '1rem', borderRadius: '8px', textAlign: 'center' }},
                        React.createElement('div', { style: { fontSize: '1rem', fontWeight: 'bold', color: '#003366' }}, 
                            stats.last_import ? new Date(stats.last_import * 1000).toLocaleString() : 'Never'
                        ),
                        React.createElement('div', { style: { color: '#666' }}, 'Last Import')
                    )
                ),

                // Import Status Panel
                (extractorRunning || importLog.length > 0) && React.createElement('div', { 
                    style: { 
                        background: extractorRunning ? '#fff3cd' : '#e8f5e9', 
                        border: extractorRunning ? '2px solid #ffc107' : '1px solid #c8e6c9',
                        padding: '1rem', 
                        borderRadius: '8px', 
                        marginBottom: '2rem' 
                    }
                },
                    React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }},
                        React.createElement('h3', { style: { margin: 0, color: extractorRunning ? '#856404' : '#2e7d32', display: 'flex', alignItems: 'center', gap: '0.5rem' }}, 
                            extractorRunning ? 'Import in Progress...' : 'Import Complete'
                        ),
                        !extractorRunning && importLog.length > 0 && React.createElement('button', {
                            onClick: () => setImportLog([]),
                            style: { background: 'transparent', border: 'none', cursor: 'pointer', color: '#666', fontSize: '0.8rem' }
                        }, 'Clear')
                    ),
                    // Show current progress details
                    extractorRunning && extractorProgress && React.createElement('div', {
                        style: { 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            marginBottom: '0.5rem',
                            padding: '0.5rem',
                            background: 'rgba(255,255,255,0.5)',
                            borderRadius: '4px'
                        }
                    },
                        React.createElement('span', { style: { fontWeight: '500' }}, 
                            extractorProgress.current_calendar || 'Processing...'
                        ),
                        extractorProgress.events_extracted > 0 && React.createElement('span', { 
                            style: { 
                                background: '#28a745', 
                                color: 'white', 
                                padding: '0.25rem 0.5rem', 
                                borderRadius: '12px',
                                fontSize: '0.85rem',
                                fontWeight: 'bold'
                            }
                        }, `${extractorProgress.events_extracted} events`)
                    ),
                    extractorRunning && React.createElement('div', { 
                        style: { 
                            height: '4px', 
                            background: '#e0e0e0', 
                            borderRadius: '2px', 
                            overflow: 'hidden',
                            marginBottom: '0.5rem'
                        }
                    },
                        React.createElement('div', { 
                            style: { 
                                height: '100%', 
                                background: '#ffc107', 
                                width: '30%',
                                animation: 'pulse 1.5s infinite',
                                borderRadius: '2px'
                            }
                        })
                    ),
                    importLog.length > 0 && React.createElement('div', { 
                        style: { 
                            maxHeight: '150px', 
                            overflowY: 'auto', 
                            fontSize: '0.85rem',
                            fontFamily: 'monospace'
                        }
                    },
                        importLog.slice(-10).map((log, i) => 
                            React.createElement('div', { 
                                key: i, 
                                style: { 
                                    padding: '0.25rem 0',
                                    color: log.type === 'error' ? '#c62828' : log.type === 'success' ? '#2e7d32' : '#666'
                                }
                            }, `[${log.time}] ${log.msg}`)
                        )
                    )
                ),

                // Add Calendar Form
                React.createElement('div', { style: { background: 'white', padding: '1.5rem', borderRadius: '8px', marginBottom: '2rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }},
                    React.createElement('h2', { style: { marginBottom: '1rem', color: '#003366' }}, 'Add Calendar'),
                    React.createElement('form', { onSubmit: addCalendar, style: { display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }},
                        React.createElement('input', {
                            type: 'url',
                            placeholder: 'Published Calendar URL',
                            value: newCalendar.url,
                            onChange: (e) => setNewCalendar({...newCalendar, url: e.target.value}),
                            style: { flex: '1', minWidth: '300px', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px' }
                        }),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'e.g., AC - Year 3 - CTI English (or utcn_room_airi_obs_204@...)',
                            value: newCalendar.name,
                            onChange: (e) => setNewCalendar({...newCalendar, name: e.target.value}),
                            style: { width: '220px', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px' }
                        }),
                        React.createElement('input', {
                            type: 'color',
                            value: newCalendar.color,
                            onChange: (e) => setNewCalendar({...newCalendar, color: e.target.value}),
                            style: { width: '50px', padding: '0.25rem', border: '1px solid #ddd', borderRadius: '4px' }
                        }),
                        React.createElement('button', { 
                            type: 'submit',
                            style: { padding: '0.5rem 1rem', background: '#003366', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }
                        }, 'Add'),
                        React.createElement('button', { 
                            type: 'button',
                            onClick: importCalendar,
                            disabled: importing,
                            style: { padding: '0.5rem 1rem', background: '#28a745', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }
                        }, importing ? 'Importing...' : 'Import All')
                    )
                ),

                // Calendars List
                React.createElement('div', { style: { background: 'white', padding: '1.5rem', borderRadius: '8px', marginBottom: '2rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }},
                    React.createElement('h2', { style: { marginBottom: '1rem', color: '#003366' }}, 'Configured Calendars'),
                    calendars.length === 0 
                        ? React.createElement('p', { style: { color: '#666' }}, 'No calendars configured yet.')
                        : React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '0.5rem' }},
                            calendars.map((cal) => 
                                editingCalendar && editingCalendar.id === cal.id
                                    // Edit mode
                                    ? React.createElement('form', { 
                                        key: cal.id,
                                        onSubmit: updateCalendar,
                                        style: { 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            gap: '0.5rem', 
                                            padding: '0.75rem', 
                                            background: '#e3f2fd', 
                                            borderRadius: '4px',
                                            borderLeft: `4px solid ${editingCalendar.color || '#003366'}`,
                                            flexWrap: 'wrap'
                                        }
                                    },
                                        React.createElement('input', {
                                            type: 'text',
                                            placeholder: 'e.g., AC - Year 3 - CTI English',
                                            value: editingCalendar.name || '',
                                            onChange: (e) => setEditingCalendar({...editingCalendar, name: e.target.value}),
                                            style: { flex: '1', minWidth: '150px', padding: '0.4rem', border: '1px solid #90caf9', borderRadius: '4px' }
                                        }),
                                        React.createElement('input', {
                                            type: 'color',
                                            value: editingCalendar.color || '#003366',
                                            onChange: (e) => setEditingCalendar({...editingCalendar, color: e.target.value}),
                                            style: { width: '40px', height: '32px', padding: '2px', border: '1px solid #90caf9', borderRadius: '4px', cursor: 'pointer' }
                                        }),
                                        React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: '0.25rem', fontSize: '0.85rem' }},
                                            React.createElement('input', {
                                                type: 'checkbox',
                                                checked: editingCalendar.enabled !== 0,
                                                onChange: (e) => setEditingCalendar({...editingCalendar, enabled: e.target.checked ? 1 : 0})
                                            }),
                                            'Enabled'
                                        ),
                                        React.createElement('button', {
                                            type: 'submit',
                                            style: { padding: '0.4rem 0.75rem', background: '#28a745', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '0.85rem' }
                                        }, 'Save'),
                                        React.createElement('button', {
                                            type: 'button',
                                            onClick: () => setEditingCalendar(null),
                                            style: { padding: '0.4rem 0.75rem', background: '#6c757d', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '0.85rem' }
                                        }, 'Cancel')
                                    )
                                    // View mode
                                    : React.createElement('div', { 
                                        key: cal.id,
                                        style: { 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            gap: '1rem', 
                                            padding: '0.75rem', 
                                            background: cal.enabled === 0 ? '#f0f0f0' : '#f8f9fa', 
                                            borderRadius: '4px',
                                            borderLeft: `4px solid ${cal.color || '#003366'}`,
                                            opacity: cal.enabled === 0 ? 0.6 : 1
                                        }
                                    },
                                            React.createElement('span', { style: { flex: 1, fontWeight: '500' }}, cal.name || cal.email_address || cal.upn || 'Unnamed'),
                                            React.createElement('span', { style: { color: '#444', fontSize: '0.85rem', marginRight: '0.75rem' }}, cal.email_address || cal.upn || ''),
                                        React.createElement('span', { style: { color: '#666', fontSize: '0.85rem', maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}, cal.url),
                                        cal.enabled === 0 && React.createElement('span', { style: { fontSize: '0.75rem', color: '#999', fontStyle: 'italic' }}, 'disabled'),
                                        React.createElement('button', {
                                            onClick: () => setEditingCalendar({...cal}),
                                            style: { padding: '0.25rem 0.5rem', background: '#0066cc', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '0.8rem' }
                                        }, 'Edit'),
                                        React.createElement('button', {
                                            onClick: () => deleteCalendar(cal.id),
                                            style: { padding: '0.25rem 0.5rem', background: '#dc3545', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '0.8rem' }
                                        }, 'Delete')
                                    )
                            )
                        )
                ),

                // Manual events UI removed from React admin per request
            )
        }

        ReactDOM.createRoot(document.getElementById('admin-root')).render(React.createElement(Admin))
    </script>
</body>
</html>
