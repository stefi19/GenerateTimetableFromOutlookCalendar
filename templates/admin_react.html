<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - UTCN AC Timetable</title>
    <link rel="stylesheet" href="/frontend/assets/index-DL3vvXPq.css">
    <style>
        /* Admin-specific overrides */
        .admin-header {
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .admin-header .back-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            transition: all 0.2s;
        }
        .admin-header .back-link:hover {
            background: rgba(255,255,255,0.1);
        }
        .admin-notice {
            background: #fff3cd;
            color: #856404;
            padding: 0.75rem 1rem;
            text-align: center;
            font-size: 0.9rem;
        }
        @keyframes pulse {
            0%, 100% { width: 30%; margin-left: 0; }
            50% { width: 50%; margin-left: 25%; }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>UTCN Timetable — Admin</h1>
        <a href="/" class="back-link">← Back to Schedule</a>
    </div>
    <div class="admin-notice">
        You are logged in as administrator. All changes will be saved immediately.
    </div>
    <div id="admin-root"></div>
    
    <script type="module">
        import React from 'https://esm.sh/react@18'
        import ReactDOM from 'https://esm.sh/react-dom@18/client'
        
    const COLORS = ['#003366', '#0066cc', '#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#20c997', '#e83e8c']
    const WARNING_THRESHOLD_SECONDS = 60 // show warning when remaining ≤ this (seconds)

        function Admin() {
            const [calendars, setCalendars] = React.useState([])
            const [loading, setLoading] = React.useState(true)
            const [importing, setImporting] = React.useState(false)
            const [extractorRunning, setExtractorRunning] = React.useState(false)
            const [extractorProgress, setExtractorProgress] = React.useState(null)
            const [message, setMessage] = React.useState(null)
            const [newCalendar, setNewCalendar] = React.useState({ url: '', name: '', color: '#003366' })
            const [editingCalendar, setEditingCalendar] = React.useState(null)
            const [stats, setStats] = React.useState({ events_count: 0, last_import: null })
            const [importLog, setImportLog] = React.useState([])
            const [plannedOrder, setPlannedOrder] = React.useState([])
            const [showFullPreview, setShowFullPreview] = React.useState(false)
            const [sessionRemaining, setSessionRemaining] = React.useState(null)
            const [warningInfo, setWarningInfo] = React.useState(null)

            const extendSession = async () => {
                try {
                    const r = await fetch('/admin/extend_session', { method: 'POST' })
                    if (r.ok) {
                        const j = await r.json()
                        setSessionRemaining(j.remaining_seconds || null)
                        setWarningInfo(null)
                        showMessage('Session extended', 'success')
                    } else {
                        showMessage('Failed to extend session', 'error')
                    }
                } catch (e) {
                    showMessage('Error extending session', 'error')
                }
            }

            const fetchData = React.useCallback(async (showLoading = true) => {
                try {
                    if (showLoading) setLoading(true)
                    const res = await fetch('/admin/api/status')

                    // If the API returns 401 (unauthenticated) or a login HTML page,
                    // redirect the browser to the login page with expired flag so the
                    // server shows the form and the UX is consistent.
                    if (!res.ok) {
                        if (res.status === 401) {
                            // show a notification and wait for user to click to go to login
                            setMessage({ text: 'Session expired. Click to go to login.', type: 'expired' })
                            return
                        }
                        // other non-OK statuses: surface a message
                        console.error('Admin status fetch failed', res.status)
                        return
                    }

                    // Some servers may respond with HTML login form (content-type text/html)
                    // even with a 200 status if the user is unauthenticated and the
                    // request followed a redirect. Detect that and treat as expired.
                    const ct = (res.headers.get('content-type') || '').toLowerCase()
                    if (ct.includes('text/html')) {
                        // assume login form; show notification and wait for user click
                        setMessage({ text: 'Session expired. Click to go to login.', type: 'expired' })
                        return
                    }

                    const data = await res.json()
                    // Sort calendars primarily by `name`. Calendars without a name are placed after named ones.
                    const sorted = (data.calendars || []).slice().sort((a, b) => {
                        const an = (a && a.name) ? a.name.toString().toLowerCase() : ''
                        const bn = (b && b.name) ? b.name.toString().toLowerCase() : ''
                        // Put unnamed entries after named entries
                        if (!an && bn) return 1
                        if (an && !bn) return -1
                        return an.localeCompare(bn)
                    })
                    setCalendars(sorted)
                    // manual events are intentionally excluded from this admin UI
                    setStats({ events_count: data.events_count || 0, last_import: data.last_import })
                    setExtractorRunning(data.extractor_running || false)
                    setExtractorProgress(data.extractor_progress || null)
                    setPlannedOrder(data.planned_order || [])
                    // Prefer server-side extractor log entries for short live updates
                    if (data.extractor_log && data.extractor_log.length) {
                        setImportLog(prev => {
                            const merged = [...prev]
                            data.extractor_log.forEach(l => {
                                if (!merged.find(x => x.msg === l)) {
                                    merged.push({ time: new Date().toLocaleTimeString(), msg: l, type: 'info' })
                                }
                            })
                            return merged.slice(-500)
                        })
                    }

                    // Full extractor stdout is intentionally not exposed in the UI

                    // Auto-add progress messages to log
                    if (data.extractor_progress && data.extractor_progress.message) {
                        setImportLog(prev => {
                            const lastMsg = prev.length > 0 ? prev[prev.length - 1].msg : ''
                            if (lastMsg !== data.extractor_progress.message) {
                                return [...prev, { 
                                    time: new Date().toLocaleTimeString(), 
                                    msg: data.extractor_progress.message, 
                                    type: 'info' 
                                }]
                            }
                            return prev
                        })
                    }
                } catch (e) {
                    console.error(e)
                } finally {
                    if (showLoading) setLoading(false)
                }
            }, [])

            // Initial load
            React.useEffect(() => { fetchData() }, [fetchData])
            
            // Poll every 2 seconds when extractor is running
            React.useEffect(() => {
                const interval = setInterval(() => {
                    fetchData(false)
                }, 2000)
                return () => clearInterval(interval)
            }, [fetchData])

            // Poll session remaining seconds every 5 seconds and maintain a local
            // second-by-second decrement for a smooth live countdown.
            React.useEffect(() => {
                let mounted = true
                let localTimer = null

                async function refresh() {
                    try {
                        const r = await fetch('/admin/session_status')
                        if (!r.ok) {
                            if (r.status === 401) {
                                // mark expired and wait for user to click login
                                setMessage({ text: 'Session expired. Click to go to login.', type: 'expired' })
                                return
                            }
                            return
                        }
                        const j = await r.json()
                        if (!mounted) return
                        setSessionRemaining(j.remaining_seconds || 0)
                        // show warning when remaining is small but not expired
                        if (j.remaining_seconds && j.remaining_seconds > 0 && j.remaining_seconds <= WARNING_THRESHOLD_SECONDS) {
                            setWarningInfo({ secs: j.remaining_seconds })
                        } else {
                            setWarningInfo(null)
                        }
                        // start local decrement
                        if (localTimer) clearInterval(localTimer)
                        localTimer = setInterval(() => {
                            setSessionRemaining(prev => {
                                if (typeof prev !== 'number') return prev
                                if (prev <= 0) {
                                    clearInterval(localTimer)
                                    return 0
                                }
                                return prev - 1
                            })
                        }, 1000)
                    } catch (e) {
                        // ignore
                    }
                }

                // initial call + periodic refresh every 5s
                refresh()
                const perf = setInterval(refresh, 5000)
                return () => { mounted = false; clearInterval(perf); if (localTimer) clearInterval(localTimer) }
            }, [])

            const showMessage = (text, type) => {
                setMessage({ text, type })
                setTimeout(() => setMessage(null), 4000)
            }

            const addCalendar = async (e) => {
                e.preventDefault()
                if (!newCalendar.url) return showMessage('URL is required', 'error')
                
                try {
                    setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Adding calendar...', type: 'info' }])
                    const form = new FormData()
                    form.append('calendar_url', newCalendar.url)
                    form.append('calendar_name', newCalendar.name)
                    form.append('calendar_color', newCalendar.color)
                    
                    const res = await fetch('/admin/set_calendar_url', { method: 'POST', body: form })
                    if (res.ok) {
                        setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Calendar added! Starting import...', type: 'success' }])
                        showMessage('Calendar added - importing events...', 'success')
                        setNewCalendar({ url: '', name: '', color: '#003366' })
                        fetchData(false)
                    }
                } catch (e) {
                    setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Error: ' + e.message, type: 'error' }])
                    showMessage('Error adding calendar', 'error')
                }
            }

            const importCalendar = async () => {
                setImporting(true)
                setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Starting import for all calendars...', type: 'info' }])
                try {
                    const res = await fetch('/admin/import_calendar', { method: 'POST' })
                    const data = await res.json()
                    setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: data.message || 'Import started', type: 'success' }])
                    showMessage(data.message || 'Import started', 'success')
                } catch (e) {
                    setImportLog(prev => [...prev, { time: new Date().toLocaleTimeString(), msg: 'Import error: ' + e.message, type: 'error' }])
                    showMessage('Import error', 'error')
                } finally {
                    setImporting(false)
                }
            }

            const deleteCalendar = async (id) => {
                if (!confirm('Are you sure you want to delete this calendar?')) return
                try {
                    const form = new FormData()
                    form.append('id', id)
                    const res = await fetch('/admin/delete_calendar', { method: 'POST', body: form })
                    if (res.ok) {
                        showMessage('Calendar deleted', 'success')
                        fetchData()
                    }
                } catch (e) {
                    showMessage('Error deleting', 'error')
                }
            }

            // Manual event creation/deletion handlers removed from this admin UI

            const updateCalendar = async (e) => {
                e.preventDefault()
                if (!editingCalendar) return
                try {
                    const form = new FormData()
                    form.append('id', editingCalendar.id)
                    form.append('name', editingCalendar.name || '')
                    form.append('color', editingCalendar.color || '#003366')
                    form.append('enabled', editingCalendar.enabled ? '1' : '0')
                    const res = await fetch('/admin/update_calendar', { method: 'POST', body: form })
                    const data = await res.json()
                    if (data.success) {
                        showMessage('Calendar updated', 'success')
                        setEditingCalendar(null)
                        fetchData()
                    } else {
                        showMessage(data.message || 'Error updating', 'error')
                    }
                } catch (e) {
                    showMessage('Error updating calendar', 'error')
                }
            }

            if (loading) {
                return React.createElement('div', { className: 'admin-loading', style: { padding: '2rem', textAlign: 'center' } }, 
                    React.createElement('div', { className: 'spinner' }),
                    ' Loading...'
                )
            }

            return React.createElement('div', { className: 'admin-container', style: { padding: '2rem', maxWidth: '1200px', margin: '0 auto' } },
                // Message
                message && (message.type === 'expired'
                    ? React.createElement('div', {
                        className: 'admin-message expired',
                        style: {
                            padding: '1rem',
                            marginBottom: '1rem',
                            borderRadius: '8px',
                            background: '#fff3cd',
                            color: '#856404',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }
                    },
                        React.createElement('span', null, message.text),
                        React.createElement('button', {
                            onClick: () => { window.location = '/admin?expired=1' },
                            style: { marginLeft: '1rem', padding: '0.5rem 0.75rem', background: '#003366', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }
                        }, 'Go to login')
                    )
                    : React.createElement('div', {
                        className: `admin-message ${message.type}`,
                        style: {
                            padding: '1rem',
                            marginBottom: '1rem',
                            borderRadius: '8px',
                            background: message.type === 'success' ? '#d4edda' : '#f8d7da',
                            color: message.type === 'success' ? '#155724' : '#721c24'
                        }
                    }, message.text)
                ),

                // Warning banner when session is about to expire (shows before 'expired')
                warningInfo && (!message || message.type !== 'expired') && React.createElement('div', {
                    className: 'admin-message warning',
                    style: {
                        padding: '1rem',
                        marginBottom: '1rem',
                        borderRadius: '8px',
                        background: '#fff3cd',
                        color: '#856404',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center'
                    }
                },
                    React.createElement('span', null, `Session will expire in ${warningInfo.secs} seconds.`),
                    React.createElement('div', null,
                        React.createElement('button', {
                            onClick: extendSession,
                            style: { marginLeft: '1rem', padding: '0.4rem 0.6rem', background: '#28a745', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }
                        }, 'Extend session'),
                        React.createElement('button', {
                            onClick: () => { window.location = '/admin?expired=1' },
                            style: { marginLeft: '0.6rem', padding: '0.4rem 0.6rem', background: '#003366', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }
                        }, 'Go to login')
                    )
                ),

                // Session indicator (minutes remaining)
                React.createElement('div', { style: { textAlign: 'right', marginBottom: '0.5rem', color: '#333', fontSize: '0.95rem' } },
                    sessionRemaining !== null
                        ? React.createElement('span', null, `Session: ${Math.max(0, Math.ceil(sessionRemaining / 60))} min${sessionRemaining >= 120 ? 's' : ''} remaining`)
                        : null
                ),

                // Stats
                React.createElement('div', { className: 'admin-stats', style: { 
                    display: 'grid', 
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                    gap: '1rem',
                    marginBottom: '2rem'
                }},
                    React.createElement('div', { style: { background: '#f8f9fa', padding: '1rem', borderRadius: '8px', textAlign: 'center' }},
                        React.createElement('div', { style: { fontSize: '2rem', fontWeight: 'bold', color: '#003366' }}, calendars.length),
                        React.createElement('div', { style: { color: '#666' }}, 'Calendars')
                    ),
                    React.createElement('div', { style: { background: '#f8f9fa', padding: '1rem', borderRadius: '8px', textAlign: 'center' }},
                        React.createElement('div', { style: { fontSize: '2rem', fontWeight: 'bold', color: '#003366' }}, stats.events_count),
                        React.createElement('div', { style: { color: '#666' }}, 'Events')
                    ),
                    React.createElement('div', { style: { background: '#f8f9fa', padding: '1rem', borderRadius: '8px', textAlign: 'center' }},
                        React.createElement('div', { style: { fontSize: '1rem', fontWeight: 'bold', color: '#003366' }}, 
                            stats.last_import ? new Date(stats.last_import * 1000).toLocaleString() : 'Never'
                        ),
                        React.createElement('div', { style: { color: '#666' }}, 'Last Import')
                    )
                ),

                // Import Status Panel
                (extractorRunning || importLog.length > 0) && React.createElement('div', { 
                    style: { 
                        background: extractorRunning ? '#fff3cd' : '#e8f5e9', 
                        border: extractorRunning ? '2px solid #ffc107' : '1px solid #c8e6c9',
                        padding: '1rem', 
                        borderRadius: '8px', 
                        marginBottom: '2rem' 
                    }
                },
                    React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }},
                        React.createElement('h3', { style: { margin: 0, color: extractorRunning ? '#856404' : '#2e7d32', display: 'flex', alignItems: 'center', gap: '0.5rem' }}, 
                            extractorRunning ? 'Import in Progress...' : 'Import Complete'
                        ),
                        !extractorRunning && importLog.length > 0 && React.createElement('button', {
                            onClick: () => setImportLog([]),
                            style: { background: 'transparent', border: 'none', cursor: 'pointer', color: '#666', fontSize: '0.8rem' }
                        }, 'Clear')
                    ),
                    // Show current progress details
                    extractorRunning && extractorProgress && React.createElement('div', {
                        style: { 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            marginBottom: '0.5rem',
                            padding: '0.5rem',
                            background: 'rgba(255,255,255,0.5)',
                            borderRadius: '4px'
                        }
                    },
                        React.createElement('span', { style: { fontWeight: '500' }}, 
                            extractorProgress.current_calendar || 'Processing...'
                        ),
                        extractorProgress.events_extracted > 0 && React.createElement('span', { 
                            style: { 
                                background: '#28a745', 
                                color: 'white', 
                                padding: '0.25rem 0.5rem', 
                                borderRadius: '12px',
                                fontSize: '0.85rem',
                                fontWeight: 'bold'
                            }
                        }, `${extractorProgress.events_extracted} events`)
                    ),
                    extractorRunning && React.createElement('div', { 
                        style: { 
                            height: '4px', 
                            background: '#e0e0e0', 
                            borderRadius: '2px', 
                            overflow: 'hidden',
                            marginBottom: '0.5rem'
                        }
                    },
                        React.createElement('div', { 
                            style: { 
                                height: '100%', 
                                background: '#ffc107', 
                                width: '30%',
                                animation: 'pulse 1.5s infinite',
                                borderRadius: '2px'
                            }
                        })
                    ),
                    // (Full extractor stdout removed from UI by admin request)
                ),

                // Add Calendar Form
                React.createElement('div', { style: { background: 'white', padding: '1.5rem', borderRadius: '8px', marginBottom: '2rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }},
                    React.createElement('h2', { style: { marginBottom: '1rem', color: '#003366' }}, 'Add Calendar'),
                    React.createElement('form', { onSubmit: addCalendar, style: { display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }},
                        React.createElement('input', {
                            type: 'url',
                            placeholder: 'Published Calendar URL',
                            value: newCalendar.url,
                            onChange: (e) => setNewCalendar({...newCalendar, url: e.target.value}),
                            style: { flex: '1', minWidth: '300px', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px' }
                        }),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'e.g., AC - Year 3 - CTI English (or utcn_room_airi_obs_204@...)',
                            value: newCalendar.name,
                            onChange: (e) => setNewCalendar({...newCalendar, name: e.target.value}),
                            style: { width: '220px', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px' }
                        }),
                        React.createElement('input', {
                            type: 'color',
                            value: newCalendar.color,
                            onChange: (e) => setNewCalendar({...newCalendar, color: e.target.value}),
                            style: { width: '50px', padding: '0.25rem', border: '1px solid #ddd', borderRadius: '4px' }
                        }),
                        React.createElement('button', { 
                            type: 'submit',
                            style: { padding: '0.5rem 1rem', background: '#003366', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }
                        }, 'Add'),
                        React.createElement('button', { 
                            type: 'button',
                            onClick: importCalendar,
                            disabled: importing,
                            style: { padding: '0.5rem 1rem', background: '#28a745', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }
                        }, importing ? 'Importing...' : 'Import All')
                    )
                    
                ),
                // CSV Controls - always visible, placed before Configured Calendars as requested
                React.createElement('div', { style: { background: '#f8f9fa', padding: '1rem', borderRadius: '8px', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '8px' } },
                    React.createElement('a', { href: '/download/Rooms_PUBLISHER_HTML-ICS(in).csv', download: 'Rooms_PUBLISHER_HTML-ICS.csv', className: 'btn btn-secondary', style: { padding: '0.4rem 0.6rem', background: '#6c757d', color: 'white', borderRadius: '4px', textDecoration: 'none' } }, 'Download CSV'),
                    React.createElement('div', { style: { display: 'flex', gap: '6px', alignItems: 'center' } },
                        React.createElement('input', { id: 'upload-csv-input-global', name: 'file', type: 'file', accept: '.csv', style: { padding: '0.2rem' } }),
                        React.createElement('button', { id: 'upload-csv-btn-global', type: 'button', onClick: null, style: { padding: '0.4rem 0.6rem', background: '#007bff', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' } }, 'Upload CSV')
                    )
                ),

                // Calendars List
                React.createElement('div', { style: { background: 'white', padding: '1.5rem', borderRadius: '8px', marginBottom: '2rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }},
                    React.createElement('h2', { style: { marginBottom: '1rem', color: '#003366' }}, 'Configured Calendars'),
                    calendars.length === 0 
                        ? React.createElement('p', { style: { color: '#666' }}, 'No calendars configured yet.')
                        : React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '0.5rem' }},
                            calendars.map((cal) => 
                                editingCalendar && editingCalendar.id === cal.id
                                    // Edit mode
                                    ? React.createElement('form', { 
                                        key: cal.id,
                                        onSubmit: updateCalendar,
                                        style: { 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            gap: '0.5rem', 
                                            padding: '0.75rem', 
                                            background: '#e3f2fd', 
                                            borderRadius: '4px',
                                            borderLeft: `4px solid ${editingCalendar.color || '#003366'}`,
                                            flexWrap: 'wrap'
                                        }
                                    },
                                        React.createElement('input', {
                                            type: 'text',
                                            placeholder: 'e.g., AC - Year 3 - CTI English',
                                            value: editingCalendar.name || '',
                                            onChange: (e) => setEditingCalendar({...editingCalendar, name: e.target.value}),
                                            style: { flex: '1', minWidth: '150px', padding: '0.4rem', border: '1px solid #90caf9', borderRadius: '4px' }
                                        }),
                                        React.createElement('input', {
                                            type: 'color',
                                            value: editingCalendar.color || '#003366',
                                            onChange: (e) => setEditingCalendar({...editingCalendar, color: e.target.value}),
                                            style: { width: '40px', height: '32px', padding: '2px', border: '1px solid #90caf9', borderRadius: '4px', cursor: 'pointer' }
                                        }),
                                        React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: '0.25rem', fontSize: '0.85rem' }},
                                            React.createElement('input', {
                                                type: 'checkbox',
                                                checked: editingCalendar.enabled !== 0,
                                                onChange: (e) => setEditingCalendar({...editingCalendar, enabled: e.target.checked ? 1 : 0})
                                            }),
                                            'Enabled'
                                        ),
                                        React.createElement('button', {
                                            type: 'submit',
                                            style: { padding: '0.4rem 0.75rem', background: '#28a745', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '0.85rem' }
                                        }, 'Save'),
                                        React.createElement('button', {
                                            type: 'button',
                                            onClick: () => setEditingCalendar(null),
                                            style: { padding: '0.4rem 0.75rem', background: '#6c757d', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '0.85rem' }
                                        }, 'Cancel')
                                    )
                                    // View mode
                                    : React.createElement('div', { 
                                        key: cal.id,
                                        style: { 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            gap: '1rem', 
                                            padding: '0.75rem', 
                                            background: cal.enabled === 0 ? '#f0f0f0' : '#f8f9fa', 
                                            borderRadius: '4px',
                                            borderLeft: `4px solid ${cal.color || '#003366'}`,
                                            opacity: cal.enabled === 0 ? 0.6 : 1
                                        }
                                    },
                                            React.createElement('span', { style: { flex: 1, fontWeight: '500' }}, cal.name || cal.email_address || cal.upn || 'Unnamed'),
                                            React.createElement('span', { style: { color: '#444', fontSize: '0.85rem', marginRight: '0.75rem' }}, cal.email_address || cal.upn || ''),
                                        React.createElement('span', { style: { color: '#666', fontSize: '0.85rem', maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}, cal.url),
                                        cal.enabled === 0 && React.createElement('span', { style: { fontSize: '0.75rem', color: '#999', fontStyle: 'italic' }}, 'disabled'),
                                        React.createElement('button', {
                                            onClick: () => setEditingCalendar({...cal}),
                                            style: { padding: '0.25rem 0.5rem', background: '#0066cc', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '0.8rem' }
                                        }, 'Edit'),
                                        React.createElement('button', {
                                            onClick: () => deleteCalendar(cal.id),
                                            style: { padding: '0.25rem 0.5rem', background: '#dc3545', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '0.8rem' }
                                        }, 'Delete')
                                    )
                            )
                        )
                ),

                // Manual events UI removed from React admin per request
            )
        }

        ReactDOM.createRoot(document.getElementById('admin-root')).render(React.createElement(Admin))

        // Wire the upload button behaviour after the React tree is mounted.
        // We wait briefly for the element to exist then attach a click handler
        setTimeout(() => {
            // attach only to the permanent controls placed before Configured Calendars
            const pairs = [
                { btnId: 'upload-csv-btn-global', inputId: 'upload-csv-input-global' }
            ]
            pairs.forEach(p => {
                const uploadBtn = document.getElementById(p.btnId)
                const uploadInput = document.getElementById(p.inputId)
                if (!uploadBtn || !uploadInput) return
                // avoid double-attaching
                if (uploadBtn._attached) return
                uploadBtn._attached = true
                uploadBtn.addEventListener('click', () => {
                    if (!uploadInput.files || uploadInput.files.length === 0) {
                        alert('Please choose a CSV file to upload')
                        return
                    }
                    const file = uploadInput.files[0]
                    const fd = new FormData()
                    fd.append('file', file, file.name)

                    uploadBtn.disabled = true
                    const previousText = uploadBtn.textContent
                    uploadBtn.textContent = 'Uploading...'

                    fetch('/admin/upload_rooms_publisher', { method: 'POST', body: fd })
                    .then(r => r.json())
                    .then(j => {
                        // trigger a full status refresh so planned_order appears
                        fetch('/admin/api/status').then(()=>{})
                        alert(j.message || 'Upload complete')
                        // If server scheduled the background import, reload the
                        // admin UI so the running import and planned order are
                        // shown automatically (avoids needing to press "Import All").
                        if (j && j.success) {
                            window.location.reload()
                        }
                    })
                    .catch(e => {
                        console.error('Upload failed', e)
                        alert('Upload failed')
                    })
                    .finally(() => {
                        uploadBtn.disabled = false
                        uploadBtn.textContent = previousText
                    })
                })
            })
        }, 400)
    </script>
</body>
</html>
