<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Timetable Results</title>
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; max-width: 900px; margin: 40px auto; padding: 0 20px; }
      h2 { margin-top: 28px; }
      .event { padding: 6px 0; border-bottom: 1px dashed #eee; }
      .meta { color: #666; font-size: 0.9rem }
      a.back { display:inline-block; margin-top: 18px }
    </style>
  </head>
  <body>
    <a class="back" href="/">← Back</a>
    <h1>Timetable</h1>
    {% if error %}
      <p style="color:crimson">{{ error }}</p>
    {% endif %}

    {% if diagnostics and diagnostics.candidates %}
      <div style="background:#f7f7f7;padding:10px;border-radius:6px;margin:12px 0;border:1px solid #eee">
        <strong>Diagnostics:</strong>
        <div>Candidates found by renderer:</div>
        <ul>
          {% for c in diagnostics.candidates %}
            <li><a href="{{ c }}" target="_blank">{{ c }}</a></li>
          {% endfor %}
        </ul>
        {% if diagnostics.used_candidate %}
          <div style="color:green">Used candidate: {{ diagnostics.used_candidate }}</div>
        {% endif %}
        {% if diagnostics.last_response_file %}
          <div>Saved last response: <a href="/__last_response" target="_blank">open saved response</a></div>
        {% endif %}
        {% if diagnostics.saved_files %}
          <div>Saved network responses:</div>
          <ul>
            {% for f in diagnostics.saved_files %}
              <li><a href="/__saved/{{ f }}" target="_blank">{{ f }}</a></li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    {% endif %}

    {% if diagnostics and diagnostics.extract_stdout is defined %}
      <div style="background:#f0f7ff;padding:10px;border-radius:6px;margin:12px 0;border:1px solid #cfe3ff">
        <strong>Extractor output (stdout):</strong>
        <pre style="white-space:pre-wrap">{{ diagnostics.extract_stdout }}</pre>
        {% if diagnostics.extract_stderr %}
          <strong style="color:crimson">Extractor stderr:</strong>
          <pre style="white-space:pre-wrap;color:crimson">{{ diagnostics.extract_stderr }}</pre>
        {% endif %}
        <div>Return code: {{ diagnostics.returncode }}</div>
      </div>
    {% endif %}

    {% if grouped and grouped|length > 0 %}
      {% for d in grouped|dictsort %}
        <h2>{{ d[0].strftime('%A, %Y-%m-%d') }}</h2>
        {% for e in d[1] %}
          <div class="event">
            <div><strong>{{ e.timestr() }}</strong> — {{ e.display_title or e.title }}</div>
            <div class="meta">{{ e.location }} {% if e.description %}• {{ e.description }}{% endif %}</div>
          </div>
        {% endfor %}
      {% endfor %}
    {% else %}
      <p>No events found in the supplied calendar or date range.</p>
    {% endif %}
  </body>
</html>
